<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Jezzball</title>
    <style type="text/css">
    
    body
    {
        font-family:Helvetica;
    }
    
    #fgCanvas
    {
        cursor:w-resize;
    }

    .label-title
    {
        font-weight: 900
    }
       
    </style>

    <script type="text/javascript">


        /**
        * Provides requestAnimationFrame in a cross browser way.
        * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
        */

        // shim layer with setTimeout fallback
        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame ||
          window.oRequestAnimationFrame ||
          window.msRequestAnimationFrame ||
          function (/* function */callback, /* DOMElement */element) {
              window.setTimeout(callback, 1000 / 60);
          };
        })();



        var gfx = null;

        var fgContext = null;
        var fgCanvas = null;

        var bgContext = null;
        var bgCanvas = null;

        var TILE_DEFAULT = 0;
        var TILE_BLUE = 1;
        var TILE_RED = 2;
        var TILE_CLEARED = 3;

        var SPRITE_BLUE = 0;
        var SPRITE_RED = 1;

        var background_Map = [
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_DEFAULT, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED,
            TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED, TILE_CLEARED];


        var speed = 512;

        var MAX_NB_BALLS = 125;

        

        var columns = []; for(var i=0; i < 32; i++) columns[i] = 0;
        var rows = [];  for(var i=0; i < 24; i++) rows[i] = 0;

        var width = 32;
        var level = 1;
        var nbBalls = 0;
        var lives = 0;
        
        var levelScore = 0;
        var totalScore = 0;
        var bonus = 0;

        var gameover = 0
        var levelComplete = 0;

        var complete = 0;
        var time4lvl = 0;
        var timeLeft = 0;
        var collision = []; for(var i=0; i < 1024; i++) collision[i] = 0;
        var blueWall = { x1: 0, y1: 0, x2: 0, y2: 0, vx: 0, vy: 0, xdirection: 0, ydirection: 0 };
        var redWall = { x1: 0, y1: 0, x2: 0, y2: 0, vx: 0, vy: 0, xdirection: 0, ydirection: 0 };
        var wbd = { x: 120, y: 88, vx: 0, vy: 0, xdirection: 0, ydirection: 0, angle: 0, stretched: 0 };

        var balls = [];
        for(var i=0; i < MAX_NB_BALLS; i++)
            balls[i] = { x: 0, y: 0, vx: 0, vy: 0, animframe: 0, animtimer: 0 };

        var mouseDown = false;
        var mouseX = 0;
        var mouseY = 0;

		var counter = 0;

		var playername = "";

        window.onload = function () {
            init();       
        }

        function updateScore() {
            document.getElementById("lives").innerHTML = lives;
            document.getElementById("score").innerHTML = levelScore + totalScore;
			document.getElementById("complete").innerHTML = Math.round(complete) + "%";
            document.getElementById("level").innerHTML = level;
            document.getElementById("timeleft").innerHTML = timeLeft;
        }

		
	    function init() {
	

            bgCanvas = document.getElementById("bgCanvas");
            bgContext = bgCanvas.getContext("2d");
            fgCanvas = document.getElementById("fgCanvas");
            fgContext = fgCanvas.getContext("2d");

            fgCanvas.oncontextmenu = function (e) {
                if (e.preventDefault) e.preventDefault();
                else e.returnValue = false;
                return false;
            }

            fgCanvas.onmousedown = function (e) {

                var isRightMB;
                e = e || window.event;

                if ("which" in e)  // Gecko (Firefox), WebKit (Safari/Chrome) & Opera
                    isRightMB = e.which == 3;
                else if ("button" in e)  // IE, Opera 
                    isRightMB = e.button == 2;

                if (!isRightMB) {

                    mouseDown = true;

                    if (e.offsetX) {
                        mouseX = e.offsetX;
                        mouseY = e.offsetY;
                    }
                    else if (e.layerX) {
                        mouseX = e.layerX;
                        mouseY = e.layerY;
                    }

                    mouseX = e.offsetX;
                    mouseY = e.offsetY;
                }
                else {
                    wbd.angle++;
                    wbd.angle &= 1;

                    if (wbd.angle == 0)
                        fgCanvas.style.cursor = "w-resize";
                    else
                        fgCanvas.style.cursor = "n-resize";

                    
                }
            }

            fgCanvas.onmouseup = function () {
                mouseDown = false;
            }

            gfx = new Image();

            gfx.onload = function() {
                initLevel(level);
				animate();
            };
            gfx.src = 'jezzball_gfx.png';

	    }

	    function closeHighscoresWindow() {
	        document.getElementById('highscores-container').style.display = 'none';
	        gameover = 0;
	        totalScore = 0;
            level = 1;
	        initLevel(level);
	    }

	    function promptHighscore() {

	        document.getElementById('highscores-container').style.display = '';
	        playername = prompt("Por favor introduce tu nombre para registrar tu puntuación. " + totalScore + " (Nivel " + level + ")\n", playername);

            try
            {
	            var xmlhttp = new XMLHttpRequest();
	            xmlhttp.open("POST", "../Highscores/Jezzball", false);
	            xmlhttp.setRequestHeader("Content-Type", "text/json");
	            xmlhttp.send(JSON.stringify({ rank: 0, player: playername, score: totalScore, level: level }));

	            if (xmlhttp.responseText) {

	                //console.log(xmlhttp.responseText);
	                var scores = JSON.parse(xmlhttp.responseText);
	                //console.log(scores);
	                document.getElementById("highscores").innerHTML = "";

	                var currentRank = 1;
	                for (var i = 0; i < scores.top.length; i++) {


	                    var playerIsInTopTen = (scores.top[i].rank == scores.player.rank);

	                    var tr = document.createElement("tr");
	                    
                        var rankTd = document.createElement("td");
                        if (playerIsInTopTen) {
                            var rankStrong = document.createElement("strong");
                            rankStrong.innerHTML = scores.top[i].rank;
                            rankTd.appendChild(rankStrong);
	                    }
                        else
                            rankTd.innerHTML = scores.top[i].rank;

                        var playerTd = document.createElement("td");
                        if (playerIsInTopTen) {
                            var playerStrong = document.createElement("strong");
                            playerStrong.innerHTML = scores.top[i].player;
                            playerTd.appendChild(playerStrong);
                        }
                        else
                            playerTd.innerHTML = scores.top[i].player;

                        var scoreTd = document.createElement("td");
                        if (playerIsInTopTen) {
                            var scoreStrong = document.createElement("strong");
                            scoreStrong.innerHTML = scores.top[i].score;
                            scoreTd.appendChild(scoreStrong);
                        }
                        else
	                        scoreTd.innerHTML = scores.top[i].score;

                        var leveTd = document.createElement("td");
                        if (playerIsInTopTen) {
                            var levelStrong = document.createElement("strong");
                            levelStrong.innerHTML = scores.top[i].level;
                            leveTd.appendChild(levelStrong);
                        }
                        else
	                        leveTd.innerHTML = scores.top[i].level;

	                    tr.appendChild(rankTd);
	                    tr.appendChild(playerTd);
	                    tr.appendChild(scoreTd);
	                    tr.appendChild(leveTd);

	                    document.getElementById("highscores").appendChild(tr);

	                    currentRank++;
	                }

	                if (scores.player.rank > 10) {

	                    var playerScoreTr = document.createElement("tr");

	                    var playerRankTd = document.createElement("td");
	                    var playerRankStrong = document.createElement("strong");
	                    playerRankTd.appendChild(playerRankStrong);
	                    playerRankStrong.innerHTML = scores.player.rank;

	                    var playerPlayerTd = document.createElement("td");
	                    var playerPlayerStrong = document.createElement("strong");
	                    playerPlayerTd.appendChild(playerPlayerStrong);
	                    playerPlayerStrong.innerHTML = scores.player.player;

	                    var playerScoreTd = document.createElement("td");
	                    var playerScoreStrong = document.createElement("strong");
	                    playerScoreTd.appendChild(playerScoreStrong);
	                    playerScoreStrong.innerHTML = scores.player.score;

	                    var playerLevelTd = document.createElement("td");
	                    var playerLevelStrong = document.createElement("strong");
	                    playerLevelTd.appendChild(playerLevelStrong);
	                    playerLevelStrong.innerHTML = scores.player.level;

	                    playerScoreTr.appendChild(playerRankTd);
	                    playerScoreTr.appendChild(playerPlayerTd);
	                    playerScoreTr.appendChild(playerScoreTd);
	                    playerScoreTr.appendChild(playerLevelTd);

	                    document.getElementById("highscores").appendChild(playerScoreTr);
	                }

	            }
	            else {
                    alert("No se recibieron puntuaciones del servidor, por favor intenta de nuevo más tarde.")
	            }
            }
            catch(e)
            {
                alert("No se ha podido conectar con el servidor, por favor intenta de nuevo más tarde. " + e);
            }

        }

        function gameOver() {
            gameover = 1;
            alert("FIN DE LA PARTIDA");
            totalScore += levelScore;
            document.getElementById("score").innerHTML = totalScore;
            promptHighscore();
        }

	    function animate() {

			counter++;
			requestAnimFrame(animate);
	        fgContext.clearRect(0, 0, fgCanvas.width, fgCanvas.height);

	        if (!gameover && !levelComplete) {
	            play(counter);
	        }
	        else if (levelComplete) {
			
				//alert("Has superado el nivel " + level);
                levelComplete = 0;
	            totalScore += levelScore;
	            initLevel(++level);
	        }
	       
        }

        function initLevel(level)
        {
            var i, j;

            nbBalls = level + 1;
            lives = nbBalls;
            complete = 0;
            time4lvl = 1300;
            counter = 0;
            for (i=0; i<level; i++)
                time4lvl += (i&1) * 100 + 200;

            timeLeft = time4lvl;
            levelScore = 0;
            levelComplete = 0;
            bonus = 0;
    
            
    
            blueWall = { x1: 0, y1: 0, x2: 0, y2: 0, vx: 0, vy: 0, xdirection: 0, ydirection: 0 };
            redWall = { x1: 0, y1: 0, x2: 0, y2: 0, vx: 0, vy: 0, xdirection: 0, ydirection: 0 };
			
            initBalls();
            initWbd();
            initBackground();
			
			tilesToClear = 0;
            for (i=0; i<32; i++)
            {
                for (j=0; j<24; j++)
                {
                    if (background_Map[j*width+i] == TILE_CLEARED)
                    {
                        collision[j*width+i] = TILE_CLEARED;
                    }
                    else
                    {
                        collision[j*width+i] = TILE_DEFAULT;
                        tilesToClear++;
                    }
                }
            }
        }

        function initWbd() {
        }

        function initBackground()
        {
            for(var i=0; i < 32; i++)
            {
                for(var j=0; j < 24; j++) {
                    setMapTile(i, j, background_Map[j * width + i]);
                }
            }
        }

        function randMinMax(min, max) {
            return Math.random() * (max - min) + min;
        }

        function initBalls()
        {
            var i;
    
            for (i=0; i<nbBalls; i++)
            {
                var x, y;
                
                balls[i].xdirection = Math.random() > 0.5 ? -1 : 1;
                balls[i].ydirection = Math.random() > 0.5 ? -1 : 1;

                x = randMinMax(3, 30);
                y = randMinMax(3, 22);

                while (collision[y*width+x] == TILE_CLEARED)
                {
                    x = randMinMax(1, 30);
                    y = randMinMax(1, 22);
                }

                balls[i].x = x << 3;
                balls[i].y = y << 3;
                balls[i].vx = balls[i].x << 8;
                balls[i].vy = balls[i].y << 8;

                drawBall(balls[i]);
                
            }
        }

        function play(counter)
        {
		
            moveBalls(counter);
            moveWbd();

            if (!gameover) {

                buildWall(blueWall, redWall, wbd.angle % 2 ? 0 : -1,
                wbd.angle % 2 ? 1 : 0, TILE_BLUE, SPRITE_BLUE);

                buildWall(redWall, blueWall, wbd.angle % 2 ? 0 : 1,
                wbd.angle % 2 ? -1 : 0, TILE_RED, SPRITE_RED);

                timeLeft = time4lvl - Math.round((((counter * speed) >> 8)) / 6.);
                if (timeLeft <= 0) {
                    timeLeft = 0;
                    gameOver();
                }

                updateScore();
            }
            
        }

        function moveBalls(counter)
        {
            var i;
            var bouncePlayed = 0;
            var jezzdeadPlayed = 0;

            for (i=0; i < nbBalls; i++)
            {
                var left = TILE_DEFAULT, top = TILE_DEFAULT, right = TILE_DEFAULT, bottom = TILE_DEFAULT, check;

                // left
                check = checkCollision((balls[i].x - 1), (balls[i].y + 4));
                if (check != TILE_DEFAULT)
                {
                    left = check;
                }

                // top left
                check = checkCollision((balls[i].x + 1), (balls[i].y + 1));
                if (check != TILE_DEFAULT)
                {
                    top = left = check;
                }

                // top
                check = checkCollision((balls[i].x + 4), (balls[i].y - 1));
                if (check != TILE_DEFAULT)
                {
                    top = check;
                }

                // right top
                check = checkCollision((balls[i].x + 7), (balls[i].y + 1));
                if (check != TILE_DEFAULT)
                {
                    right = top = check;
                }

                // right
                check = checkCollision((balls[i].x + 8), (balls[i].y + 4));
                if (check != TILE_DEFAULT)
                {
                    right = check;
                }

                // bottom right
                check = checkCollision((balls[i].x + 7), (balls[i].y + 7));
                if (check != TILE_DEFAULT)
                {
                    bottom = right = check;
                }

                // bottom
                check = checkCollision((balls[i].x + 4), (balls[i].y + 8));
                if (check != TILE_DEFAULT)
                {
                    bottom = check;
                }

                // left bottom
                check = checkCollision((balls[i].x + 1), (balls[i].y + 7));
                if (check != TILE_DEFAULT)
                {
                    left = bottom = check;
                }

                if (top == TILE_CLEARED || bottom == TILE_CLEARED || right == TILE_CLEARED || left == TILE_CLEARED)
                {
                    if (!bouncePlayed) {
                        //playSound(bounce);
                        bouncePlayed = 1;
                    }
                }
        
                if (top == TILE_BLUE || bottom == TILE_BLUE || right == TILE_BLUE || left == TILE_BLUE)
                {
                    lives--;
                    if (lives == 0)
                        gameOver();

                    fillWall(blueWall, TILE_DEFAULT, SPRITE_BLUE);
            
                    if (!jezzdeadPlayed) {
                        //playSound(jezzdead);
                        jezzdeadPlayed = 1;
                    }
                }
                if (top == TILE_RED || bottom == TILE_RED || right == TILE_RED || left == TILE_RED)
                {
                    lives--;
                    if (lives == 0)
                        gameOver();
            
                    fillWall(redWall, TILE_DEFAULT, SPRITE_RED);

                    if (!jezzdeadPlayed) {
                        //playSound(jezzdead);
                        jezzdeadPlayed = 1;
                    }
                }
        
                if (!(top == TILE_CLEARED && bottom == TILE_CLEARED) && !(right == TILE_CLEARED && left == TILE_CLEARED))
                {
                    if (right == TILE_CLEARED)
                        balls[i].xdirection = -1;
                    else if (left == TILE_CLEARED)
                        balls[i].xdirection = 1;

                    if (bottom == TILE_CLEARED)
                        balls[i].ydirection = -1;
                    else if (top == TILE_CLEARED)
                        balls[i].ydirection = 1;

                    balls[i].vx += balls[i].xdirection * speed;
                    balls[i].vy += balls[i].ydirection * speed;
                    balls[i].x = balls[i].vx >> 8;
                    balls[i].y = balls[i].vy >> 8;
                }
                else
                {
                    // stop the ball
                    var modulo;

                    balls[i].xdirection = balls[i].ydirection = 0;

                    modulo = balls[i].x & 7;
                    if (modulo <= 4)
                    {
                        balls[i].x -= modulo;
                        balls[i].vx = balls[i].x << 8;
                    }
                    else
                    {
                        balls[i].x = balls[i].x - modulo + 8;
                        balls[i].vx = balls[i].x << 8;
                    }

                    modulo = balls[i].y & 7;
                    if (modulo <= 4)
                    {
                        balls[i].y -= modulo;
                        balls[i].vy = balls[i].y << 8;
                    }
                    else
                    {
                        balls[i].y = balls[i].y - modulo + 8;
                        balls[i].vy = balls[i].y << 8;
                    }
                }

                // balls collision
                var j;
                for (j=0; j<i; j++)
                { 
                    // test collisions for all balls with a smaller number...
                    if (getSquaredDistanceBetweenTwoPoints(balls[i].x, balls[i].y, balls[j].x, balls[j].y) < 8*8)
                    {
                        balls[i].xdirection = balls[i].x - balls[j].x > 0 ? 1 : -1;
                        balls[i].ydirection = balls[i].y - balls[j].y > 0 ? 1 : -1;
                        balls[j].xdirection = -(balls[i].xdirection);
                        balls[j].ydirection = -(balls[i].ydirection);

                        if (!bouncePlayed) {
                            //playSound(bounce);
                            bouncePlayed = 1;
                        }
                    }
                }
        
                drawBall(balls[i]);
            }
        }

        function getSquaredDistanceBetweenTwoPoints(x1, y1, x2, y2)
        {
           return ((x2 - x1)*(x2 - x1)) + ((y2 - y1)*(y2 - y1));  
        }

        function drawBall(ball) {

			ball.animtimer ++;
			if(ball.animtimer > 3)
			{
				ball.animtimer = 0;
				ball.animframe ++;
				ball.animframe %= 9;
			}
				
            fgContext.drawImage(gfx, 0, ball.animframe*8, 8, 8, ball.x, ball.y, 8, 8);

            /*fgContext.beginPath();
            fgContext.rect(ball.x, ball.y, 8, 8);
            fgContext.fillStyle = 'yellow';
            fgContext.fill();*/	
        }

        function moveWbd() {
        }

          function checkCollision(x, y)
          {
            var x2, y2;
    
            x2 = x>>3;
            y2 = y>>3;
    
            if (x2 <= -1 || y2 <= -1 || x2 >= 32 || y2 >= 24)
              return TILE_CLEARED;
            else
              return collision[y2*width+x2];
        }

        function drawWallHead(spritenum, x, y) {

            //SPRITE_RED, SPRITE_BLUE
            fgContext.drawImage(gfx, 0, 80 + (spritenum * 8), 8, 8, x, y, 8, 8);

        }

        function setMapTile(x, y, tilenum) {

            if (tilenum == TILE_CLEARED)
            {
                bgContext.fillStyle = 'black';
                bgContext.beginPath();
                bgContext.rect(x * 8, y * 8, 8, 8);
                bgContext.fill();
            }
            else
                bgContext.drawImage(gfx, 0, 96 + (tilenum*8), 8,8, x*8,y*8,8,8); //TILE_DEFAULT, TILE_BLUE, TILE_RED
        }


          function buildWall(thiswall, otherwall, xstep, ystep, tilenum, spritenum)
          {
            var x, y;

            if (complete < 75 && (mouseDown)) {

                wbd.x = mouseX;
                wbd.y = mouseY;

                x = ((wbd.x)>>3) + (xstep>0 ? 1 : 0);
                y = ((wbd.y)>>3) + (ystep>0 ? 1 : 0);

                if (x >= 0 && y >= 0 && x < 32 && y < 24 && thiswall.xdirection == 0 && thiswall.ydirection == 0 && collision[y*width+x] == TILE_DEFAULT
                    && !((otherwall.x1 != otherwall.x2 || otherwall.y1 != otherwall.y2) && (otherwall.xdirection == -1 || otherwall.ydirection == -1) && y*width+x == (otherwall.y2>>3)*width+(otherwall.x2>>3))
                    && !((otherwall.x1 != otherwall.x2 || otherwall.y1 != otherwall.y2) && (otherwall.xdirection == 1 || otherwall.ydirection == 1) && y*width+x == ((otherwall.y2>>3)+otherwall.ydirection)*width+((otherwall.x2>>3)+otherwall.xdirection))
                ) {

                    thiswall.xdirection = xstep;
                    thiswall.ydirection = ystep;

                    thiswall.x1 = thiswall.x2 = (x<<3);
                    thiswall.y1 = thiswall.y2 = (y<<3);
                    thiswall.vx = thiswall.x2 << 8;
                    thiswall.vy = thiswall.y2 << 8;

                    setMapTile(x, y, tilenum);
                    collision[y * width + x] = tilenum;

                    drawWallHead(spritenum, thiswall.x2, thiswall.y2);  
                }
            }
            else if (thiswall.xdirection != 0 || thiswall.ydirection != 0)
              {
                var xnext, ynext, otherxnext, otherynext;
        
                x = xnext = ((thiswall.x2 + 4)>>3);
                y = ynext = ((thiswall.y2 + 4)>>3);
                if (thiswall.xdirection != 0)
                  xnext += thiswall.xdirection > 0 ? 1 : -1;
                if (thiswall.ydirection != 0)
                  ynext += thiswall.ydirection > 0 ? 1 : -1;
                otherxnext = ((otherwall.x2 + 4 + otherwall.xdirection)>>3);
                otherynext = ((otherwall.y2 + 4 + otherwall.ydirection)>>3);
        
                if ( (thiswall.xdirection > 0 && thiswall.x2 == 248)
                    || (thiswall.xdirection < 0 && thiswall.x2 == 0)
                    || (thiswall.ydirection > 0 && thiswall.y2 == 184)
                    || (thiswall.ydirection < 0 && thiswall.y2 == 0)
                    || (collision[ynext*width+xnext] == TILE_CLEARED && (thiswall.x2 & 7) == 0 && (thiswall.y2 & 7) == 0))
                  {
                    fillWall(thiswall, TILE_CLEARED, spritenum);
                    clearEmptyRooms();
                  }
                else if (
                       (collision[ynext*width+xnext] != TILE_DEFAULT && (thiswall.x2 & 7) == 0 && (thiswall.y2 & 7) == 0)
                       || (thiswall.ydirection == 1 && otherwall.y2 == thiswall.y2 + 8 && otherwall.x2 < thiswall.x2 + 8 && otherwall.x2 > thiswall.x2 - 8)
                       || (thiswall.ydirection == -1 && otherwall.y2 == thiswall.y2 - 8 && otherwall.x2 < thiswall.x2 + 8 && otherwall.x2 > thiswall.x2 - 8)
                       || (thiswall.xdirection == 1 && otherwall.x2 == thiswall.x2 + 8 && otherwall.y2 < thiswall.y2 + 8 && otherwall.y2 > thiswall.y2 - 8)
                       || (thiswall.xdirection == -1 && otherwall.x2 == thiswall.x2 - 8 && otherwall.y2 < thiswall.y2 + 8 && otherwall.y2 > thiswall.y2 - 8)
                    )
                  { // blue and red collision
                    // wait
                  }
                else
                  {
                    thiswall.vx += thiswall.xdirection * speed;
                    thiswall.vy += thiswall.ydirection * speed;
                    thiswall.x2 = thiswall.vx >> 8;
                    thiswall.y2 = thiswall.vy >> 8;

                    if ((thiswall.x2 & 7) == 0 && (thiswall.y2 & 7) == 0)
                    {
                      x = ((thiswall.x2 + 4)>>3);
                      y = ((thiswall.y2 + 4)>>3);

                      setMapTile(x, y, tilenum);
                      collision[y*width+x] = tilenum;
                    }
                  }

                 drawWallHead(spritenum, thiswall.x2, thiswall.y2); 
              }
          }

          function fillWall(wall, tilenum, spritenum)
          {
            var x, y, start, end, step;
    
            if (wall.xdirection != 0)
            {
                start = ((wall.x1)>>3);
                step = wall.xdirection;
                end = ((wall.x2)>>3) + step;
                y = (wall.y1)>>3;
        
                for (x=start; x!=end; x+=step)
                {
                    setMapTile(x, y, tilenum == TILE_DEFAULT ? background_Map[y*width+x] : tilenum);
                    collision[y*width+x] = tilenum;
                }
            }
            else if (wall.ydirection != 0)
            {
                start = ((wall.y1)>>3);
                step = wall.ydirection;
                end = ((wall.y2)>>3) + step;
                x = (wall.x1)>>3;
        
                for (y=start; y!=end; y+=step)
                {
                    setMapTile(x, y, tilenum == TILE_DEFAULT ? background_Map[y*width+x] : tilenum);
                    collision[y*width+x] = tilenum;
                    if (tilenum == TILE_CLEARED)
                    {
                        columns[x]++;
                        rows[y]++;
                    }
                }
            }

            wall.x1 = wall.x2 = wall.y1 = wall.y2 = -8;
            wall.vx = wall.vy = -8 << 3;
            wall.xdirection = wall.ydirection = 0;
    
             checkIfWin();
        }

        function clearEmptyRooms()
          {
              var cleared = [];
              for (var i = 0; i < 32; i++) {
                  cleared[i] = [];
                  for (var j = 0; j < 24; j++) {
                      cleared[i][j] = 0;
                  }
              }
    
            var tilesComplete;
            var change = 1;
            var x, y, i;

            for (y=0; y<24; y++)
              {
                rows[y] = 0;
                for (x=0; x<32; x++)
                  {
                    rows[x] = 0;
                    cleared[x][y] = 1;
                  }
              }

            for (i=0; i<nbBalls; i++)
              {
                x = (balls[i].x + 4)>>3;
                y = (balls[i].y + 4)>>3;

                cleared[x][y] = 0;
              }

            while (change)
              {
                change = 0;
                for (y=0; y<24; y++)
                  for (x=0; x<32; x++)
                    {
                      if (!cleared[x][y])
                        {
                          if (cleared[x][y+1] && (y+1) < 24 && collision[(y+1)*width+(x)] != TILE_CLEARED)
                            {
                              cleared[x][y+1] = 0;
                              change = 1;
                            }
                          if (cleared[x+1][y] && (x+1) < 32 && collision[(y)*width+(x+1)] != TILE_CLEARED)
                            {
                              cleared[x+1][y] = 0;
                              change = 1;
                            }
                        }
                    }
                for (y=23; y>=0; y--)
                  for (x=31; x>=0; x--)
                    {
                      if (!cleared[x][y])
                        {
                          if (cleared[x][y-1] && (y-1) >= 0 && collision[(y-1)*width+(x)] != TILE_CLEARED)
                            {
                              cleared[x][y-1] = 0;
                              change = 1;
                            }
                          if (cleared[x-1][y] && (x-1) >= 0 && collision[(y)*width+(x-1)] != TILE_CLEARED)
                            {
                              cleared[x-1][y] = 0;
                              change = 1;
                            }
                        }
                    }
              }

            tilesComplete = 0;
            for (y=0; y<24; y++)
              for (x=0; x<32; x++)
                if (cleared[x][y]) {
                    setMapTile(x, y, TILE_CLEARED);
                    collision[y*width+x] = TILE_CLEARED;
                    if (background_Map[y*width+x] != TILE_CLEARED)
                      tilesComplete++;
                    columns[x]++;
                    rows[y]++;
                  }
                else if (collision[y*width+x] == TILE_CLEARED)
                  {
                    if (background_Map[y*width+x] != TILE_CLEARED)
                      tilesComplete++;
                    columns[x]++;
                    rows[y]++;
                  }

            complete = ((tilesComplete*100)/tilesToClear + .5);
    
            levelScore = tilesComplete * (30 + 5 * level);
            checkIfWin();
        }

        function checkIfWin()
          {
            if (complete >= 75 && blueWall.xdirection == 0 && blueWall.ydirection == 0 && redWall.xdirection == 0 && redWall.ydirection == 0)
              {
                var x, y;
        
                for (y=0; y<24; y++)
                  if (rows[y] == 32)
                    bonus += (30 + 5 * level) * 32;
                for (x=0; x<32; x++)
                  if (columns[x] == 24)
                    bonus += (30 + 5 * level) * 24;
        
                bonus += (timeLeft * lives * level * speed) >> 8;
                bonus += (((complete - 79) * level * speed) >> 8) * 100;
                bonus += (((complete - 89) * level * speed) >> 8) * 200;
        
                levelScore += bonus;
                levelComplete = 1;
              }
          }



    </script>
</head>
<body>
   <div id="game-container">
	   <div id="game" >
	   <div style="position: relative">
	   
		    <canvas style="z-index: 0; position: absolute; top: 0px; left: 0px" id="bgCanvas" width="256" height="192"></canvas>
		    <canvas style="z-index: 1; position: absolute; top: 0px; left: 0px" id="fgCanvas" width="256" height="192"></canvas>

            <div id="highscores-container"  style="display: none; position: absolute; top: 0px; left: 0px; z-index: 2; background-color: White; width: 256px; height: 300px;">
                
                Tabla de puntuaciones
                <table>
                    <thead>
                       <tr><th>Posición</th><th>Jugador</th><th>Puntuación</th><th>Nivel</th></tr>
                    </thead>
                    <tbody id="highscores">
                    </tbody>
                </table>
                <a href="#" onclick="closeHighscoresWindow()" >Volver a intentar</a>
            </div>

		</div>
	   </div>
   </div>
   		

  <div style="position:absolute; left: 290px; border-left: 2px solid black; padding-left: 15px">
       <span class="label-title">Nivel:</span><div style="margin-left: 45px" id="level"></div>
       <span class="label-title">Completado:</span> <div style="margin-left: 45px" id="complete"></div>
       <span class="label-title">Vidas:</span><div style="margin-left: 45px" id="lives"></div>
       <span class="label-title">Puntos:</span><div style="margin-left: 45px" id="score"></div>
       <span class="label-title">Tiempo:</span><div style="margin-left: 45px" id="timeleft"></div>
   </div>

</body>
</html>